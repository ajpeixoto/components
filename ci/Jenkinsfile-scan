/*
 * Copyright (C) 2010-2022 Talend Inc. - www.talend.com
 *
 * This source code is available under agreement available at https://www.talend.com/legal-terms/us-eula
 *
 * You should have received a copy of the agreement along with this program; if not, write to Talend SA
 * 5 rue Salomon de Rothschild - 92150 Suresnes, France
 *
 */
def POD_DEFINITION_FILE = 'ci/resources/buildPodDefinition.yaml'

pipeline {
  agent {
    kubernetes {
      yamlFile POD_DEFINITION_FILE
      defaultContainer 'talend-builder'
    }
  }

  environment {
    MAVEN_OPTS = '-Dmaven.artifact.threads=128 -Dorg.slf4j.simpleLogger.showThreadName=true -Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss'
    TALEND_REGISTRY = 'registry.datapwn.com'
    VERACODE_APP_NAME = 'Components'
    VERACODE_SANDBOX = 'components'
    APP_ID = '579232'
    SLACK_CHANNEL = 'tdp_ci'
  }

  options {
    buildDiscarder(logRotator(artifactNumToKeepStr: '5', numToKeepStr: '5'))
    timeout(time: 60, unit: 'MINUTES')
    skipStagesAfterUnstable()
  }

  triggers {
    cron('0 9 * * 0')
  }

  stages {
    stage('Prepare') {
      steps {
        configFileProvider([configFile(fileId: 'maven-settings-nexus-zl', variable: 'MAVEN_SETTINGS')]) {
          echo 'Install tools'
          sh 'bash --login ci/resources/install-tools.sh'
          sh '''#! /bin/bash
                        # Pass the maven credentials to the sourceclear command for the maven build, using an agent configuration file
                        # Unfortunately there seems to be no simpler way
                        # See configuration options here: https://help.veracode.com/reader/hHHR3gv0wYc2WbCclECf_A/7kaHTtCxKiogPGnzcDk0eA
                        echo "customMavenOptions: --settings ${MAVEN_SETTINGS}" > agent-override.yml
                        chmod 600 agent-override.yml

                        mvn clean install \
                          --batch-mode \
                          --threads 1C \
                          --update-snapshots \
                          --define 'skipTests' \
                          --settings "$MAVEN_SETTINGS"
                    '''
        }
      }
    }
    stage("SourceClear analysis") {
      steps {
        withCredentials([string(credentialsId: 'veracode-token', variable: 'SRCCLR_API_TOKEN')]) {
          sh '''#!/bin/bash
                      curl -sSL https://download.sourceclear.com/ci.sh \
                        | SRCCLR_API_TOKEN=${SRCCLR_API_TOKEN} DEBUG=1 sh -s -- \
                            --config agent-override.yml \
                            scan \
                            --allow-dirty \
                            --recursive \
                            --skip-collectors npm;
                    '''
        }
      }
    }
  }
  post {
    success {
      slackSend(color: '#00FF00', message: "SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})", channel: "${SLACK_CHANNEL}")
    }
    failure {
      slackSend(color: '#FF0000', message: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})", channel: "${SLACK_CHANNEL}")
    }
  }
}
